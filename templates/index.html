<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cloud RAM SaaS</title>

  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

  <!-- ✅ Click-safety rules to prevent invisible overlays stealing clicks -->
  <style>
    #loading-text { pointer-events: none; }
    #status-message { pointer-events: none; }

    /* Ensure allocate button is always clickable above nearby panels */
    #allocate-btn {
      position: relative;
      z-index: 50;
      pointer-events: auto;
    }
    #allocate-agent-panel {
      position: relative;
      z-index: 1;
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Existing app scripts -->
  <script src="/static/config.js" defer></script>
  <script src="/static/script.js" defer></script>
</head>

<body>
  <div id="app">
    <nav id="nav" style="display:none;">
      <button onclick="navigate('home')">Home</button>
      <button onclick="navigate('allocate')">Allocate RAM</button>
      <button onclick="logout()">Sign Out</button>
    </nav>

    <!-- Login Page -->
    <div id="login-page" style="display:block;">
      <h1>Login to Cloud RAM SaaS</h1>

      <form onsubmit="event.preventDefault(); login();">
        <div>
          <label>Email:</label>
          <input type="email" id="login-email" required autocomplete="email" />
        </div>

        <div>
          <label>Password:</label>
          <input type="password" id="login-password" required autocomplete="current-password" />
        </div>

        <button type="button" onclick="login()">Login</button>
      </form>

      <button onclick="navigate('register')">Register</button>
      <button onclick="loginWithGoogle()">Login with Google</button>

      <p id="login-error" style="color:red;"></p>
    </div>

    <!-- Registration Page -->
    <div id="register-page" style="display:none;">
      <h1>Register for Cloud RAM SaaS</h1>

      <form onsubmit="event.preventDefault(); registerUser();">
        <div>
          <label>First Name:</label>
          <input type="text" id="register-firstname" required />
        </div>

        <div>
          <label>Last Name:</label>
          <input type="text" id="register-lastname" required />
        </div>

        <div>
          <label>Phone Number:</label>
          <input type="tel" id="register-phone" required />
        </div>

        <div>
          <label>Email:</label>
          <input type="email" id="register-email" required />
        </div>

        <div>
          <label>Password:</label>
          <input type="password" id="register-password" required />
        </div>

        <button type="submit">Register</button>
      </form>

      <button onclick="navigate('login')">Back to Login</button>
      <p id="register-error" style="color:red;"></p>
    </div>

    <!-- Home Page -->
    <div id="home-page" style="display:none;">
      <h1>Welcome to Cloud RAM SaaS</h1>
      <p>Use the navigation to allocate Cloud RAM.</p>
      <p id="user-email" style="font-weight:bold;"></p>
    </div>

    <!-- Allocate RAM Page -->
    <div id="allocate-page" style="display:none;">
      <h1>Cloud RAM Allocation</h1>

      <p><strong>Instructions:</strong></p>
      <ul>
        <li>After clicking Allocate, creating online Cloud RAM takes 10–15 minutes.</li>
        <li>Once you create RAM, it will be terminated if you close the browser tab.</li>
      </ul>

      <!-- Local Agent Panel -->
      <div id="allocate-agent-panel"
           style="margin:14px 0; padding:14px; border-radius:10px;
                  background: rgba(255,255,255,0.10);
                  border: 1px solid rgba(255,255,255,0.20);">

        <div style="font-weight:bold; font-size:16px;">
          Local Agent Required
        </div>

        <div style="margin-top:6px; font-size:13px; opacity:0.9;">
          You must run the Local Agent on this computer before allocating RAM.
          This enables secure task discovery and local sync.
        </div>

        <div id="allocate-agent-status"
             style="margin-top:10px; font-weight:bold;"></div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="button"
                  id="allocate-install-run"
                  type="button">
            Install & Run Agent
          </button>

          <button class="button"
                  id="allocate-agent-retry"
                  type="button">
            Retry Agent
          </button>
        </div>

        <div style="margin-top:10px; font-size:13px; opacity:0.9;">
          Health check: <code>http://127.0.0.1:7071/health</code>
        </div>
      </div>

      <label>Choose RAM:</label>
      <select id="ram">
        <option value="1">1 GB</option>
        <option value="2">2 GB</option>
        <option value="4">4 GB</option>
      </select>

      <!-- ✅ IMPORTANT: Inline onclick fallback (works even if JS binding fails) -->
      <button id="allocate-btn" type="button" disabled onclick="window.allocateClickFlow && window.allocateClickFlow()">Allocate</button>

      <p id="loading-text" style="display:none; color:blue;">Processing...</p>
      <p id="status-message"></p>
    </div>
  </div>
</body>
</html>