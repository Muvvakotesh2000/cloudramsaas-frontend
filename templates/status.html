<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud RAM Dashboard</title>

  <!-- Supabase + auth helper -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/static/config.js" defer></script>
  <script src="/static/status_auth.js?v=6" defer></script>

  <!-- ‚úÖ UI Enhancements only (IDs + JS unchanged) -->
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0A1022;
      --card:rgba(255,255,255,.07);
      --card2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.14);
      --muted:rgba(255,255,255,.74);
      --text:#F5F7FF;
      --accent:#36C2FF;
      --accent2:#7C5CFF;
      --danger:#FF5B5B;
      --danger2:#FF8A8A;
      --ok:#30D989;
      --warn:#FFD166;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 20%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(54,194,255,.22), transparent 55%),
        radial-gradient(700px 500px at 50% 85%, rgba(48,217,137,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Subtle grid */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.045) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity:.35;
      pointer-events:none;
      mask-image: radial-gradient(circle at 50% 35%, rgba(0,0,0,1), rgba(0,0,0,.2) 70%, rgba(0,0,0,0) 100%);
    }

    /* Layout wrapper */
    .wrap{
      width:min(1100px, 94vw);
      margin: 24px auto 44px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      padding-left:6px;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.88);
      font-weight: 600;
      letter-spacing:.15px;
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px;
      border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(255,209,102,.14);
      flex:0 0 auto;
    }

    /* Panels */
    .panel{
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      padding: 16px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .panel::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 240px at 30% 0%, rgba(54,194,255,.18), transparent 60%),
                  radial-gradient(700px 240px at 80% 0%, rgba(124,92,255,.16), transparent 60%);
      pointer-events:none;
      opacity:.85;
    }
    .panel > *{ position:relative; z-index:1; }

    .panel-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .panel-title h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); font-size: 13px; }

    /* Status card */
    #status-text{
      line-height: 1.45;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      padding: 12px 12px;
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }

    /* Buttons */
    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .button{
      appearance:none;
      border:none;
      border-radius: 12px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.15px;
      transition: transform .12s ease, filter .18s ease, background .18s ease, box-shadow .18s ease, opacity .18s ease;
      background: linear-gradient(135deg, rgba(54,194,255,.95), rgba(124,92,255,.95));
      color:#071118;
      box-shadow: 0 14px 26px rgba(124,92,255,.14);
    }
    .button:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .button:active{ transform: translateY(0); }
    .button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none !important;
      filter:none !important;
      box-shadow:none !important;
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.70);
      border: 1px solid rgba(255,255,255,.16);
    }
    .danger{
      background: linear-gradient(135deg, rgba(255,91,91,.95), rgba(255,138,138,.85));
      color:#1b0a0a;
      box-shadow: 0 14px 26px rgba(255,91,91,.14);
    }
    .danger:hover{ filter: brightness(1.03); }

    /* Select / tasks */
    #tasks-container{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    #task-loading{
      margin:0;
      padding: 10px 12px;
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }

    #tasks{
      width: 100%;
      min-height: 160px;
      padding: 10px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(7,10,18,.45);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    #tasks:focus{
      border-color: rgba(54,194,255,.55);
      box-shadow: 0 0 0 4px rgba(54,194,255,.18);
    }
    #tasks option{
      padding: 8px;
    }

    /* Status lines */
    #migration-status, #vscode-status, #save-local-status, #stop-status{
      margin: 8px 0 0;
      padding: 10px 12px;
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 700;
    }
    #migration-status:empty,
    #vscode-status:empty,
    #save-local-status:empty,
    #stop-status:empty{
      display:none;
    }

    /* Spinner */
    .spinner{
      display:inline-block;
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255,255,255,.65);
      border-radius: 50%;
      border-top: 3px solid rgba(54,194,255,1);
      animation: spin 1s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* VNC area */
    #vnc-container{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    #vnc-loading{
      margin:0;
      padding: 10px 12px;
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }
    #vnc-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: fit-content;
      text-decoration:none;
    }

    code{
      background: rgba(0,0,0,.28);
      padding: 3px 7px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.90);
    }

    /* Responsive */
    @media (max-width: 640px){
      .topbar{
        flex-wrap:wrap;
        border-radius: 18px;
      }
      .chip{
        width:100%;
        justify-content:flex-start;
      }
      .panel{ padding: 14px 14px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- ‚úÖ New header (doesn't affect JS) -->
    <div class="topbar">
      <div class="brand">
        <h1>Cloud RAM Dashboard</h1>
        <div class="sub">Monitor RAM, migrate tasks, and open VNC</div>
      </div>
      <div class="chip" title="Agent + VM status indicator (visual only)">
        <span class="dot"></span>
        <span>Dashboard Active</span>
      </div>
    </div>

    <!-- Status -->
    <div class="panel">
      <div class="panel-title">
        <h2>VM Status</h2>
        <span class="muted">Live RAM + connectivity</span>
      </div>
      <div id="status-text">Loading...</div>

      <div class="btnrow" style="margin-top:12px;">
        <button class="button danger" id="stop-vm-btn">Stop VM</button>
        <span id="stop-spinner" style="display:none;" class="spinner"></span>
      </div>
      <p id="stop-status" style="margin-top: 10px; font-weight: bold;"></p>
    </div>

    <!-- Tasks -->
    <div class="panel">
      <div class="panel-title">
        <h2>Running Tasks</h2>
        <span class="muted">Select one or more to migrate</span>
      </div>

      <div id="tasks-container">
        <p id="task-loading">Fetching tasks...</p>
        <select id="tasks" multiple></select>

        <div class="btnrow">
          <button class="button" id="migrate-btn">Migrate Selected Tasks</button>
          <span id="migration-spinner" style="display:none;" class="spinner"></span>
        </div>
        <p id="migration-status" style="margin-top: 10px; font-weight: bold;"></p>

        <div class="btnrow">
          <button class="button" id="migrate-vscode-btn" style="display:none;">Migrate VSCode Project</button>
          <span id="vscode-spinner" style="display:none;" class="spinner"></span>
        </div>
        <p id="vscode-status" style="margin-top: 10px; font-weight: bold;"></p>

        <div class="btnrow">
          <button class="button" id="save-local-btn">Save Project to Local</button>
          <span id="save-local-spinner" style="display:none;" class="spinner"></span>
        </div>
        <p id="save-local-status" style="margin-top: 10px; font-weight: bold;"></p>
      </div>
    </div>

    <!-- VNC -->
    <div class="panel">
      <div class="panel-title">
        <h2>VM GUI (VNC)</h2>
        <span class="muted">Opens in a new tab</span>
      </div>

      <div id="vnc-container">
        <p id="vnc-loading">VNC ready.</p>
        <a id="vnc-link" class="button" target="_blank" rel="noopener" style="display:none;">Open VM GUI (VNC)</a>
      </div>
    </div>
  </div>

<script>
  let taskArray = [];
  let vmIp = null;
  let vmId = null;

  const AGENT_BASE = "http://127.0.0.1:7071";

  // ========= Helpers =========
  async function apiBase() {
    const cfg = await window.loadAppConfig();
    return (cfg.API_BASE_URL || "http://127.0.0.1:8000").replace(/\/$/, "");
  }

  // ‚úÖ Better error surfacing (no "[object Object]")
  async function fetchJson(url, opts = {}) {
    const r = await fetch(url, opts);
    const text = await r.text();

    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    if (!r.ok) {
      const detail = data?.detail ?? data?.error ?? data?.message ?? data?.raw ?? `HTTP ${r.status}`;
      throw new Error(typeof detail === "string" ? detail : JSON.stringify(detail));
    }
    return data;
  }

  async function isAgentOnline() {
    try {
      const r = await fetch(`${AGENT_BASE}/health`, { cache: "no-store" });
      return r.ok;
    } catch {
      return false;
    }
  }

  async function getAccessToken() {
    if (window.getAuthHeaders) {
      const h = await window.getAuthHeaders();
      const auth = h.Authorization || h.authorization || "";
      return auth.startsWith("Bearer ") ? auth.slice("Bearer ".length) : "";
    }
    return localStorage.getItem("sb_access_token") || "";
  }

  // ‚úÖ Centralized user_id fetch
  async function getUserId() {
    const sb = window._sbClient;
    if (!sb) throw new Error("Supabase client not initialized.");
    const { data: { user } } = await sb.auth.getUser();
    const user_id = user?.id;
    if (!user_id) throw new Error("Could not determine user_id.");
    return user_id;
  }

  // ========= Dashboard init =========
  document.addEventListener("DOMContentLoaded", async () => {
    const stopBtn = document.getElementById("stop-vm-btn");
    if (stopBtn) stopBtn.addEventListener("click", stopVmNow);

    const migrateBtn = document.getElementById("migrate-btn");
    if (migrateBtn) migrateBtn.addEventListener("click", migrateSelectedTasks);

    const migrateVSCodeBtn = document.getElementById("migrate-vscode-btn");
    if (migrateVSCodeBtn) migrateVSCodeBtn.addEventListener("click", migrateVSCodeProject);

    const saveBtn = document.getElementById("save-local-btn");
    if (saveBtn) saveBtn.addEventListener("click", saveProjectToLocal);

    await initDashboard();
  });

  // ---------------------------
  // ‚úÖ ALWAYS refresh VM from backend (/my_vm)
  // ---------------------------
  async function fetchMyVmWithRetries(maxTries = 30, delayMs = 5000) {
    const headers = await window.getAuthHeaders();
    const base = await apiBase();

    for (let i = 1; i <= maxTries; i++) {
      const resp = await fetch(`${base}/my_vm`, { headers });

      const text = await resp.text();
      let info;
      try { info = JSON.parse(text); } catch { info = { raw: text }; }

      if (!resp.ok) {
        throw new Error(info.detail || info.error || info.raw || `my_vm failed (${resp.status})`);
      }

      if (!info.exists) return info;

      if ((info.state === "running" || info.state === "pending") && !info.ip) {
        document.getElementById("status-text").innerHTML =
          `‚è≥ VM is ${info.state}. Waiting for public IP... (try ${i}/${maxTries})`;
        await new Promise(r => setTimeout(r, delayMs));
        continue;
      }

      return info;
    }

    throw new Error("Timed out waiting for VM IP. Try again in a minute.");
  }

  async function initDashboard() {
    try {
      document.getElementById("status-text").innerHTML = "‚è≥ Loading VM info...";

      const info = await fetchMyVmWithRetries(36, 5000);

      if (!info.exists) {
        document.getElementById("status-text").innerHTML =
          "‚ùå No VM found for your account. Go to Allocate page and create one.";
        return;
      }

      vmId = info.vm_id || null;
      vmIp = info.ip || null;

      if (vmId) localStorage.setItem("vm_id", vmId);
      if (vmIp) localStorage.setItem("vm_ip", vmIp);

      if (info.state === "stopped" || info.state === "stopping") {
        document.getElementById("status-text").innerHTML =
          `üü° VM is ${info.state}. Go to Allocate page and click Resume.`;
        return;
      }

      if (!vmIp) {
        document.getElementById("status-text").innerHTML =
          "‚ö†Ô∏è VM exists but has no IP yet. Please wait and refresh.";
        return;
      }

      loadVncGui();
      await fetchRamUsage();

      const agentOk = await isAgentOnline();
      if (!agentOk) {
        const loadingText = document.getElementById("task-loading");
        loadingText.style.color = "crimson";
        loadingText.innerText = "‚ùå Local Agent not running. Start it to load tasks.";
        return;
      }

      await fetchLocalTasksViaAgent();

    } catch (e) {
      console.error("initDashboard failed:", e);
      document.getElementById("status-text").innerHTML = `‚ùå ${e.message || e}`;
    }
  }

  async function fetchRamUsage() {
    const headers = await window.getAuthHeaders();
    const base = await apiBase();

    const response = await fetch(`${base}/ram_usage?vm_ip=${encodeURIComponent(vmIp)}`, { headers });
    if (!response.ok) {
      const txt = await response.text().catch(() => "");
      throw new Error(`RAM usage failed (${response.status}): ${txt || response.statusText}`);
    }

    const data = await response.json();
    document.getElementById("status-text").innerHTML = `
      ‚úÖ Cloud RAM Running at ${vmIp} <br>
      üîπ Total RAM: ${(data.total_ram / (1024 ** 3)).toFixed(2)} GB<br>
      üîπ Used RAM: ${(data.used_ram / (1024 ** 3)).toFixed(2)} GB (${data.percent_used}%)<br>
      üîπ Available RAM: ${(data.available_ram / (1024 ** 3)).toFixed(2)} GB
    `;
  }

  async function stopVmNow() {
    const stopBtn = document.getElementById("stop-vm-btn");
    const spinner = document.getElementById("stop-spinner");
    const statusEl = document.getElementById("stop-status");

    try {
      statusEl.textContent = "";
      statusEl.style.color = "white";
      spinner.style.display = "inline-block";
      stopBtn.disabled = true;

      const headers = await window.getAuthHeaders();
      const vm_id = localStorage.getItem("vm_id");
      if (!vm_id) throw new Error("No vm_id found in localStorage.");

      const base = await apiBase();
      const resp = await fetch(`${base}/stop_vm`, {
        method: "POST",
        headers: { ...headers, "Content-Type": "application/json" },
        body: JSON.stringify({ vm_id })
      });

      const text = await resp.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!resp.ok) throw new Error(data.detail || data.error || data.raw || "Stop failed.");

      statusEl.style.color = "lightgreen";
      statusEl.textContent = "‚úÖ Stop requested. VM will enter STOPPED state shortly.";
    } catch (e) {
      statusEl.style.color = "crimson";
      statusEl.textContent = `‚ùå ${e.message || e}`;
    } finally {
      spinner.style.display = "none";
      stopBtn.disabled = false;
    }
  }

  async function fetchLocalTasksViaAgent() {
    const taskList = document.getElementById("tasks");
    const loadingText = document.getElementById("task-loading");

    loadingText.style.display = "block";
    loadingText.style.color = "white";
    loadingText.innerText = "Fetching local tasks via Agent...";
    taskList.innerHTML = "";
    taskArray = [];

    try {
      const data = await fetchJson(`${AGENT_BASE}/running_tasks`);
      loadingText.style.display = "none";

      if (!data.tasks || data.tasks.length === 0) {
        taskList.innerHTML = "<option>No running tasks found</option>";
        return;
      }

      data.tasks.forEach(task => {
        if (["notepad++.exe", "chrome.exe", "Code.exe"].includes(task.name)) {
          taskArray.push({ pid: task.pid, name: task.name });
        }
      });

      const hasVSCode = (data.tasks || []).some(t => (t.name || "").toLowerCase() === "code.exe");
      document.getElementById("migrate-vscode-btn").style.display = hasVSCode ? "inline-block" : "none";

      populateDropdown();
      loadingText.style.display = "block";
      loadingText.innerText = `${taskArray.length} tasks fetched.`;
    } catch (err) {
      console.error("‚ùå Error fetching local tasks:", err);
      loadingText.style.display = "block";
      loadingText.style.color = "crimson";
      loadingText.innerText = `‚ùå Failed to fetch tasks: ${err.message || err}`;
    }
  }

  function populateDropdown() {
    const taskList = document.getElementById("tasks");
    taskList.innerHTML = "";

    if (taskArray.length === 0) {
      const opt = document.createElement("option");
      opt.text = "No tasks available";
      taskList.add(opt);
      return;
    }

    taskArray.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.pid;
      opt.text = `${t.name} (PID: ${t.pid})`;
      taskList.add(opt);
    });
  }

  async function migrateSelectedTasks() {
    const migrateBtn = document.getElementById("migrate-btn");
    const spinner = document.getElementById("migration-spinner");
    const statusEl = document.getElementById("migration-status");
    const taskSelect = document.getElementById("tasks");

    try {
      spinner.style.display = "inline-block";
      migrateBtn.disabled = true;
      statusEl.style.color = "white";
      statusEl.textContent = "";

      const agentOk = await isAgentOnline();
      if (!agentOk) throw new Error("Local Agent not running.");

      const info = await fetchMyVmWithRetries(6, 3000);
      if (!info.exists || !info.ip) throw new Error("VM not running or missing IP.");
      vmIp = info.ip;
      localStorage.setItem("vm_ip", vmIp);

      const selectedOptions = Array.from(taskSelect.selectedOptions);
      if (selectedOptions.length === 0) {
        statusEl.textContent = "‚ö†Ô∏è Select at least one task.";
        return;
      }

      const task_names = selectedOptions.map(opt => opt.text.split(" (PID:")[0].trim());
      const access_token = await getAccessToken();
      if (!access_token) throw new Error("Missing Supabase access token.");
      const user_id = await getUserId();

      const result = await fetchJson(`${AGENT_BASE}/migrate_tasks`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token, user_id, vm_ip: vmIp, task_names })
      });

      const okCount = (result.results || []).filter(r => r.success).length;
      const total = (result.results || []).length;

      statusEl.style.color = "lightgreen";
      statusEl.textContent = `‚úÖ Migration completed: ${okCount}/${total} succeeded.`;
    } catch (err) {
      console.error(err);
      statusEl.style.color = "crimson";
      statusEl.textContent = `‚ùå ${err.message || err}`;
    } finally {
      spinner.style.display = "none";
      migrateBtn.disabled = false;
    }
  }

  async function migrateVSCodeProject() {
    const btn = document.getElementById("migrate-vscode-btn");
    const spinner = document.getElementById("vscode-spinner");
    const statusEl = document.getElementById("vscode-status");

    try {
      spinner.style.display = "inline-block";
      btn.disabled = true;
      statusEl.style.color = "white";
      statusEl.textContent = "";

      const agentOk = await isAgentOnline();
      if (!agentOk) throw new Error("Local Agent not running.");

      const info = await fetchMyVmWithRetries(10, 3000);
      if (!info.exists || !info.ip) throw new Error("VM not running or missing IP.");
      vmIp = info.ip;
      localStorage.setItem("vm_ip", vmIp);

      const access_token = await getAccessToken();
      if (!access_token) throw new Error("Missing Supabase access token.");
      const user_id = await getUserId();

      const data = await fetchJson(`${AGENT_BASE}/migrate_vscode`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token, vm_ip: vmIp, user_id })
      });

      statusEl.style.color = "lightgreen";
      statusEl.textContent = `‚úÖ VSCode migrated. Opened on VM: ${data.opened_path || "unknown"}`;
    } catch (e) {
      statusEl.style.color = "crimson";
      statusEl.textContent = `‚ùå ${e.message || e}`;
    } finally {
      spinner.style.display = "none";
      btn.disabled = false;
    }
  }

  async function saveProjectToLocal() {
    const btn = document.getElementById("save-local-btn");
    const spinner = document.getElementById("save-local-spinner");
    const statusEl = document.getElementById("save-local-status");

    try {
      spinner.style.display = "inline-block";
      btn.disabled = true;
      statusEl.style.color = "white";
      statusEl.textContent = "";

      const agentOk = await isAgentOnline();
      if (!agentOk) throw new Error("Local Agent not running.");

      const project_name = prompt("Enter project folder name to save (example: CloudRAMSaaS):");
      if (!project_name) return;

      const info = await fetchMyVmWithRetries(6, 3000);
      if (!info.exists || !info.ip) throw new Error("VM not running or missing IP.");
      vmIp = info.ip;

      const access_token = await getAccessToken();
      if (!access_token) throw new Error("Missing Supabase access token.");
      const user_id = await getUserId();

      const resp = await fetchJson(`${AGENT_BASE}/save_project_to_local`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token, user_id, vm_ip: vmIp, project_name })
      });

      statusEl.style.color = "lightgreen";
      statusEl.textContent = `‚úÖ ${resp.message || "Saved successfully."}`;
    } catch (e) {
      statusEl.style.color = "crimson";
      statusEl.textContent = `‚ùå ${e.message || e}`;
    } finally {
      spinner.style.display = "none";
      btn.disabled = false;
    }
  }

  function loadVncGui() {
    const loading = document.getElementById("vnc-loading");
    const link = document.getElementById("vnc-link");

    if (!vmIp) {
      loading.style.color = "crimson";
      loading.innerText = "‚ùå No VM IP found.";
      return;
    }

    const vncUrl = `http://${vmIp}:8080/vnc.html?autoconnect=true&resize=scale`;

    loading.style.color = "lightgreen";
    loading.innerText = "‚úÖ VNC available (opens in new tab).";

    link.href = vncUrl;
    link.style.display = "inline-block";
  }
</script>

</body>
</html>
