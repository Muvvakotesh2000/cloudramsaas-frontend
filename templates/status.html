<!DOCTYPE html>
<html lang="en">
<head>
  <title>Cloud RAM Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/static/config.js"></script><!-- NOT deferred: must load first -->
  <script src="/static/status_auth.js?v=8"></script><!-- NOT deferred: kicks off init ASAP -->

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .spinner {
      display: inline-block;
      width: 24px; height: 24px;
      border: 3px solid #fff;
      border-radius: 50%;
      border-top: 3px solid #00c4cc;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .button {
      background-color: #00c4cc;
      border: none; color: white;
      padding: 10px 18px; margin: 8px 4px;
      font-size: 16px; border-radius: 6px;
      cursor: pointer; transition: background 0.3s ease;
    }
    .button:hover { background-color: #009fa3; }
    .button:disabled { background-color: #999; cursor: not-allowed; opacity: 0.6; }
    .danger { background-color: #ff5b5b; }
    .danger:hover { background-color: #e04747; }
    #tasks { min-width: 320px; min-height: 140px; }
    .panel {
      width: min(920px, 95vw);
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.20);
      border-radius: 10px;
      padding: 14px 16px; margin-top: 12px;
    }
    .muted { opacity: 0.9; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Cloud RAM Dashboard</h1>
  <div id="status-text">Loading...</div>

  <!-- Stopped VM actions panel -->
  <div id="stopped-actions" class="panel" style="display:none;">
    <div style="font-weight:bold; margin-bottom:8px;">VM Actions</div>
    <div class="muted" id="stopped-hint" style="margin-bottom:10px;"></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="button" id="resume-vm-btn" type="button">Resume VM</button>
      <button class="button danger" id="new-vm-btn" type="button">Create New VM (Terminate old)</button>
      <span id="stopped-spinner" style="display:none;" class="spinner"></span>
    </div>
    <p id="stopped-status" style="margin-top:10px; font-weight:bold;"></p>
  </div>

  <div style="margin-top:12px;">
    <button class="button danger" id="stop-vm-btn" type="button">Stop VM</button>
    <span id="stop-spinner" style="display:none;" class="spinner"></span>
    <p id="stop-status" style="margin-top:10px; font-weight:bold;"></p>
  </div>

  <h2>Running Tasks</h2>
  <div id="tasks-container">
    <p id="task-loading">Fetching tasks...</p>
    <select id="tasks" multiple></select>
    <div>
      <button class="button" id="migrate-btn" type="button">Migrate Selected Tasks</button>
      <span id="migration-spinner" style="display:none;" class="spinner"></span>
      <p id="migration-status" style="margin-top:10px; font-weight:bold;"></p>

      <button class="button" id="migrate-vscode-btn" type="button" style="display:none;">Migrate VSCode Project</button>
      <span id="vscode-spinner" style="display:none;" class="spinner"></span>
      <p id="vscode-status" style="margin-top:10px; font-weight:bold;"></p>

      <button class="button" id="save-local-btn" type="button">Save Project to Local</button>
      <span id="save-local-spinner" style="display:none;" class="spinner"></span>
      <p id="save-local-status" style="margin-top:10px; font-weight:bold;"></p>
    </div>
  </div>

  <h2>VM GUI (VNC)</h2>
  <div id="vnc-container">
    <p id="vnc-loading">VNC ready.</p>
    <a id="vnc-link" class="button" target="_blank" rel="noopener" style="display:none;">Open VM GUI (VNC)</a>
  </div>

<script>
  'use strict';

  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let vmIp = null;
  let vmId = null;
  // âœ… _stoppedVmId is set in showStoppedActions() and read by button handlers.
  // Buttons are bound ONCE in DOMContentLoaded â€” no cloning, no rebinding.
  let _stoppedVmId = null;
  let taskArray = [];

  const AGENT_BASE = "http://127.0.0.1:7071";

  // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function apiBase() {
    const cfg = await window.loadAppConfig();
    return (cfg.API_BASE_URL || "http://127.0.0.1:8000").replace(/\/$/, "");
  }

  async function fetchJson(url, opts = {}) {
    const r = await fetch(url, opts);
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }
    if (!r.ok) {
      const detail = data?.detail ?? data?.error ?? data?.message ?? data?.raw ?? `HTTP ${r.status}`;
      throw new Error(typeof detail === "string" ? detail : JSON.stringify(detail));
    }
    return data;
  }

  async function isAgentOnline() {
    try {
      const r = await fetch(`${AGENT_BASE}/health`, { cache: "no-store" });
      return r.ok;
    } catch { return false; }
  }

  // âœ… Always awaits authReady before any token call
  async function getToken() {
    await window.authReady;
    return window.getAccessToken();
  }

  async function getHeaders() {
    const token = await getToken();
    return { Authorization: `Bearer ${token}` };
  }

  async function getUserId() {
    await window.authReady;
    const sb = window._sbClient;
    if (!sb) throw new Error("Supabase not initialized.");
    const { data: { user } } = await sb.auth.getUser();
    if (!user?.id) throw new Error("Could not determine user ID.");
    return user.id;
  }

  // â”€â”€â”€ Stopped actions panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âœ… Buttons bound once in DOMContentLoaded, read _stoppedVmId at click time.
  function showStoppedActions(show, hint = "", currentVmId = null) {
    const panel    = document.getElementById("stopped-actions");
    const hintEl   = document.getElementById("stopped-hint");
    const statusEl = document.getElementById("stopped-status");
    const resumeBtn = document.getElementById("resume-vm-btn");
    const newBtn    = document.getElementById("new-vm-btn");

    if (!panel) return;
    statusEl.textContent = "";

    if (show) {
      _stoppedVmId = currentVmId || vmId || localStorage.getItem("vm_id");
      if (hintEl) hintEl.textContent = hint || "";
      if (resumeBtn) resumeBtn.disabled = false;
      if (newBtn)    newBtn.disabled    = false;
      panel.style.display = "block";
      console.log("âœ… showStoppedActions: _stoppedVmId =", _stoppedVmId);
    } else {
      panel.style.display = "none";
    }
  }

  // â”€â”€â”€ VM data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchMyVm() {
    // âœ… Always await authReady before any auth-gated request
    await window.authReady;
    const headers = await getHeaders();
    const base    = await apiBase();
    return fetchJson(`${base}/my_vm`, { headers, cache: "no-store" });
  }

  async function fetchMyVmWithRetries(maxTries = 30, delayMs = 5000) {
    for (let i = 1; i <= maxTries; i++) {
      const info = await fetchMyVm();
      if (!info.exists) return info;
      if ((info.state === "running" || info.state === "pending") && !info.ip) {
        setText(`â³ VM is ${info.state}. Waiting for IP... (${i}/${maxTries})`);
        await sleep(delayMs);
        continue;
      }
      return info;
    }
    throw new Error("Timed out waiting for VM IP.");
  }

  async function pollUntilRunning(vmIdArg, maxTries = 60, delayMs = 5000) {
    for (let i = 1; i <= maxTries; i++) {
      const info = await fetchMyVmWithRetries(1, 0);
      if (!info.exists) throw new Error("VM no longer exists.");
      if (info.state === "running" && info.ip) return info;
      setText(`â³ Waiting for VM to become RUNNING... (${i}/${maxTries})`);
      await sleep(delayMs);
    }
    throw new Error("Timed out waiting for VM to become RUNNING.");
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
  function setText(html) {
    const el = document.getElementById("status-text");
    if (el) el.innerHTML = html;
  }

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener("DOMContentLoaded", () => {
    // âœ… Bind ALL buttons ONCE here. Handlers close over _stoppedVmId at call time.
    document.getElementById("resume-vm-btn")?.addEventListener("click", () => {
      console.log("â–¶ï¸ Resume clicked, _stoppedVmId =", _stoppedVmId);
      resumeVmNow(_stoppedVmId);
    });
    document.getElementById("new-vm-btn")?.addEventListener("click", () => {
      console.log("ğŸ—‘ï¸ New VM clicked, _stoppedVmId =", _stoppedVmId);
      terminateAndNew(_stoppedVmId);
    });
    document.getElementById("stop-vm-btn")?.addEventListener("click", stopVmNow);
    document.getElementById("migrate-btn")?.addEventListener("click", migrateSelectedTasks);
    document.getElementById("migrate-vscode-btn")?.addEventListener("click", migrateVSCodeProject);
    document.getElementById("save-local-btn")?.addEventListener("click", saveProjectToLocal);

    // âœ… Wait for auth to be ready before starting dashboard
    window.authReady.then(() => {
      console.log("âœ… authReady resolved â€” starting dashboard");
      initDashboard();
    });
  });

  async function initDashboard() {
    try {
      showStoppedActions(false);
      setText("â³ Loading VM info...");

      const info = await fetchMyVmWithRetries(36, 5000);

      if (!info.exists) {
        setText("âŒ No VM found. Go to the Allocate page to create one.");
        return;
      }

      vmId = info.vm_id || null;
      vmIp = info.ip    || null;
      if (vmId) localStorage.setItem("vm_id", vmId);
      if (vmIp) localStorage.setItem("vm_ip", vmIp);

      if (info.state === "stopped" || info.state === "stopping") {
        setText(`ğŸŸ¡ VM is <b>${info.state}</b>. Resume or create a new instance below.`);
        showStoppedActions(true, `VM ID: ${vmId || "unknown"}`, vmId);
        return;
      }

      if (!vmIp) {
        setText("âš ï¸ VM has no IP yet. Please wait and refresh.");
        return;
      }

      loadVncGui();
      await fetchRamUsage();

      const agentOk = await isAgentOnline();
      if (!agentOk) {
        const el = document.getElementById("task-loading");
        el.style.color = "crimson";
        el.innerText = "âŒ Local Agent not running. Start it to load tasks.";
        return;
      }
      await fetchLocalTasksViaAgent();
    } catch (e) {
      console.error("initDashboard error:", e);
      setText(`âŒ ${e.message || e}`);
    }
  }

  async function fetchRamUsage() {
    const headers = await getHeaders();
    const base    = await apiBase();
    const data    = await fetchJson(
      `${base}/ram_usage?vm_ip=${encodeURIComponent(vmIp)}`, { headers }
    );
    setText(`
      âœ… Cloud RAM Running at ${vmIp}<br>
      ğŸ”¹ Total RAM: ${(data.total_ram / 1073741824).toFixed(2)} GB<br>
      ğŸ”¹ Used RAM: ${(data.used_ram / 1073741824).toFixed(2)} GB (${data.percent_used}%)<br>
      ğŸ”¹ Available RAM: ${(data.available_ram / 1073741824).toFixed(2)} GB
    `);
  }

  // â”€â”€â”€ Stop VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function stopVmNow() {
    const btn      = document.getElementById("stop-vm-btn");
    const spinner  = document.getElementById("stop-spinner");
    const statusEl = document.getElementById("stop-status");
    try {
      statusEl.textContent = ""; statusEl.style.color = "white";
      spinner.style.display = "inline-block";
      btn.disabled = true;

      const headers = await getHeaders();
      const vm_id   = vmId || localStorage.getItem("vm_id");
      if (!vm_id) throw new Error("No vm_id found. Refresh the page.");

      const base = await apiBase();
      await fetchJson(`${base}/stop_vm`, {
        method: "POST",
        headers: { ...headers, "Content-Type": "application/json" },
        body: JSON.stringify({ vm_id })
      });

      statusEl.style.color = "lightgreen";
      statusEl.textContent = "âœ… Stop requested. VM will stop shortly.";
      await sleep(2000);
      await initDashboard();
    } catch (e) {
      statusEl.style.color = "crimson";
      statusEl.textContent = `âŒ ${e.message || e}`;
    } finally {
      spinner.style.display = "none";
      btn.disabled = false;
    }
  }

  // â”€â”€â”€ Resume VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function resumeVmNow(effectiveVmId) {
    const spinner  = document.getElementById("stopped-spinner");
    const statusEl = document.getElementById("stopped-status");
    const resumeBtn = document.getElementById("resume-vm-btn");
    const newBtn    = document.getElementById("new-vm-btn");
    try {
      statusEl.textContent = ""; statusEl.style.color = "white";
      spinner.style.display = "inline-block";
      if (resumeBtn) resumeBtn.disabled = true;
      if (newBtn)    newBtn.disabled    = true;

      const headers = await getHeaders();
      const vm_id   = effectiveVmId || vmId || localStorage.getItem("vm_id");
      if (!vm_id) throw new Error("No vm_id. Refresh the page.");

      console.log("â–¶ï¸ Calling /start_vm with vm_id:", vm_id);
      const base = await apiBase();
      await fetchJson(`${base}/start_vm`, {
        method: "POST",
        headers: { ...headers, "Content-Type": "application/json" },
        body: JSON.stringify({ vm_id })
      });

      statusEl.style.color = "lightgreen";
      statusEl.textContent = "âœ… Resume requested. Waiting for VM...";

      const info = await pollUntilRunning(vm_id);
      vmIp = info.ip;
      vmId = info.vm_id || vm_id;
      localStorage.setItem("vm_ip", vmIp);
      localStorage.setItem("vm_id", vmId);

      statusEl.textContent = `âœ… VM is RUNNING (${vmIp}). Reloading...`;
      await sleep(800);
      await initDashboard();
    } catch (e) {
      console.error("resumeVmNow error:", e);
      statusEl.style.color = "crimson";
      statusEl.textContent = `âŒ ${e.message || e}`;
    } finally {
      spinner.style.display = "none";
      const rb = document.getElementById("resume-vm-btn");
      const nb = document.getElementById("new-vm-btn");
      if (rb) rb.disabled = false;
      if (nb) nb.disabled = false;
    }
  }

  // â”€â”€â”€ Terminate VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function terminateAndNew(effectiveVmId) {
    const spinner  = document.getElementById("stopped-spinner");
    const statusEl = document.getElementById("stopped-status");
    const resumeBtn = document.getElementById("resume-vm-btn");
    const newBtn    = document.getElementById("new-vm-btn");

    if (!confirm("This will TERMINATE your VM and ALL data will be lost permanently. Continue?")) return;

    try {
      statusEl.textContent = ""; statusEl.style.color = "white";
      spinner.style.display = "inline-block";
      if (resumeBtn) resumeBtn.disabled = true;
      if (newBtn)    newBtn.disabled    = true;

      const headers = await getHeaders();
      const vm_id   = effectiveVmId || vmId || localStorage.getItem("vm_id");
      if (!vm_id) throw new Error("No vm_id. Refresh the page.");

      console.log("ğŸ—‘ï¸ Calling /terminate_vm with vm_id:", vm_id);
      const base = await apiBase();
      await fetchJson(`${base}/terminate_vm`, {
        method: "POST",
        headers: { ...headers, "Content-Type": "application/json" },
        body: JSON.stringify({ vm_id })
      });

      vmId = null; vmIp = null;
      localStorage.removeItem("vm_id");
      localStorage.removeItem("vm_ip");

      statusEl.style.color = "lightgreen";
      statusEl.textContent = "âœ… VM terminated. Go to Allocate to create a new instance.";
    } catch (e) {
      console.error("terminateAndNew error:", e);
      statusEl.style.color = "crimson";
      statusEl.textContent = `âŒ ${e.message || e}`;
    } finally {
      spinner.style.display = "none";
      const rb = document.getElementById("resume-vm-btn");
      const nb = document.getElementById("new-vm-btn");
      if (rb) rb.disabled = false;
      if (nb) nb.disabled = false;
    }
  }

  // â”€â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchLocalTasksViaAgent() {
    const taskList    = document.getElementById("tasks");
    const loadingText = document.getElementById("task-loading");
    loadingText.style.display = "block";
    loadingText.style.color = "white";
    loadingText.innerText = "Fetching local tasks via Agent...";
    taskList.innerHTML = "";
    taskArray = [];

    try {
      const data = await fetchJson(`${AGENT_BASE}/running_tasks`);
      loadingText.style.display = "none";
      if (!data.tasks?.length) {
        taskList.innerHTML = "<option>No running tasks found</option>";
        return;
      }
      data.tasks.forEach(t => {
        if (["notepad++.exe", "chrome.exe", "Code.exe"].includes(t.name)) {
          taskArray.push({ pid: t.pid, name: t.name });
        }
      });
      const hasVSCode = data.tasks.some(t => t.name?.toLowerCase() === "code.exe");
      document.getElementById("migrate-vscode-btn").style.display = hasVSCode ? "inline-block" : "none";
      populateDropdown();
      loadingText.style.display = "block";
      loadingText.innerText = `${taskArray.length} tasks fetched.`;
    } catch (err) {
      loadingText.style.color = "crimson";
      loadingText.innerText = `âŒ Failed to fetch tasks: ${err.message || err}`;
    }
  }

  function populateDropdown() {
    const taskList = document.getElementById("tasks");
    taskList.innerHTML = "";
    if (!taskArray.length) {
      taskList.innerHTML = "<option>No tasks available</option>";
      return;
    }
    taskArray.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.pid;
      opt.text  = `${t.name} (PID: ${t.pid})`;
      taskList.add(opt);
    });
  }

  async function migrateSelectedTasks() {
    const btn      = document.getElementById("migrate-btn");
    const spinner  = document.getElementById("migration-spinner");
    const statusEl = document.getElementById("migration-status");
    const sel      = document.getElementById("tasks");
    try {
      spinner.style.display = "inline-block"; btn.disabled = true;
      statusEl.style.color = "white"; statusEl.textContent = "";

      if (!await isAgentOnline()) throw new Error("Local Agent not running.");
      const info = await fetchMyVmWithRetries(6, 3000);
      if (!info.exists || !info.ip) throw new Error("VM not running or missing IP.");
      vmIp = info.ip; localStorage.setItem("vm_ip", vmIp);

      const selected = Array.from(sel.selectedOptions);
      if (!selected.length) { statusEl.textContent = "âš ï¸ Select at least one task."; return; }

      const task_names = selected.map(o => o.text.split(" (PID:")[0].trim());
      const access_token = await getToken();
      const user_id      = await getUserId();

      const result = await fetchJson(`${AGENT_BASE}/migrate_tasks`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token, user_id, vm_ip: vmIp, task_names })
      });
      const ok = (result.results || []).filter(r => r.success).length;
      statusEl.style.color = "lightgreen";
      statusEl.textContent = `âœ… Migration: ${ok}/${(result.results || []).length} succeeded.`;
    } catch (e) {
      statusEl.style.color = "crimson"; statusEl.textContent = `âŒ ${e.message || e}`;
    } finally {
      spinner.style.display = "none"; btn.disabled = false;
    }
  }

  async function migrateVSCodeProject() {
    const btn      = document.getElementById("migrate-vscode-btn");
    const spinner  = document.getElementById("vscode-spinner");
    const statusEl = document.getElementById("vscode-status");
    try {
      spinner.style.display = "inline-block"; btn.disabled = true;
      statusEl.style.color = "white"; statusEl.textContent = "";

      if (!await isAgentOnline()) throw new Error("Local Agent not running.");
      const info = await fetchMyVmWithRetries(10, 3000);
      if (!info.exists || !info.ip) throw new Error("VM not running or missing IP.");
      vmIp = info.ip; localStorage.setItem("vm_ip", vmIp);

      const access_token = await getToken();
      const user_id      = await getUserId();
      const data = await fetchJson(`${AGENT_BASE}/migrate_vscode`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token, vm_ip: vmIp, user_id })
      });
      statusEl.style.color = "lightgreen";
      statusEl.textContent = `âœ… VSCode migrated. Opened: ${data.opened_path || "unknown"}`;
    } catch (e) {
      statusEl.style.color = "crimson"; statusEl.textContent = `âŒ ${e.message || e}`;
    } finally {
      spinner.style.display = "none"; btn.disabled = false;
    }
  }

  async function saveProjectToLocal() {
    const btn      = document.getElementById("save-local-btn");
    const spinner  = document.getElementById("save-local-spinner");
    const statusEl = document.getElementById("save-local-status");
    try {
      spinner.style.display = "inline-block"; btn.disabled = true;
      statusEl.style.color = "white"; statusEl.textContent = "";

      if (!await isAgentOnline()) throw new Error("Local Agent not running.");
      const project_name = prompt("Enter project folder name (e.g. CloudRAMSaaS):");
      if (!project_name) return;

      const info = await fetchMyVmWithRetries(6, 3000);
      if (!info.exists || !info.ip) throw new Error("VM not running or missing IP.");
      vmIp = info.ip;

      const access_token = await getToken();
      const user_id      = await getUserId();
      const resp = await fetchJson(`${AGENT_BASE}/save_project_to_local`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token, user_id, vm_ip: vmIp, project_name })
      });
      statusEl.style.color = "lightgreen";
      statusEl.textContent = `âœ… ${resp.message || "Saved successfully."}`;
    } catch (e) {
      statusEl.style.color = "crimson"; statusEl.textContent = `âŒ ${e.message || e}`;
    } finally {
      spinner.style.display = "none"; btn.disabled = false;
    }
  }

  // â”€â”€â”€ VNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadVncGui() {
    const loading = document.getElementById("vnc-loading");
    const link    = document.getElementById("vnc-link");
    if (!vmIp) {
      loading.style.color = "crimson";
      loading.innerText = "âŒ No VM IP found.";
      return;
    }
    loading.style.color = "lightgreen";
    loading.innerText = "âœ… VNC available (opens in new tab).";
    link.href = `http://${vmIp}:8080/vnc.html?autoconnect=true&resize=scale`;
    link.style.display = "inline-block";
  }
</script>
</body>
</html>